# 動画生成機能 - 完全実装計画

**作成日**: 2025年11月17日  
**プロジェクト**: YouTube動画分析アプリ  
**作成者**: Manus AI

---

## 📋 エグゼクティブサマリー

本ドキュメントは、YouTube動画分析アプリに実装予定の「動画生成機能」の完全な実装計画をまとめたものです。この機能により、「テーマを入力 → ボタンクリック → 動画がエクスポートされる」というシンプルなUXを実現し、ベンチマーク分析からRAG蓄積、戦略設計、シナリオ生成、スライド生成、動画合成まで、全てを自動化します。

---

## 🎯 プロジェクト目標

### 核心的な要件

1. **シンプルなUX**: テーマ入力 → ボタンクリック → 待つだけ
2. **バックグラウンド処理**: ユーザーがページを閉じても処理を継続
3. **サーバー再起動対応**: 未完了のジョブを自動再開
4. **RAG自動蓄積**: ベンチマーク分析結果を自動的にRAGに保存
5. **リアルタイム進捗表示**: 残り時間と進捗率を表示
6. **詳細ページアクセス**: 各ステップの詳細を確認・編集可能
7. **寿命の長い動画**: ベンチマーク分析とRAGを活用し、バズる法則を学習

### 従来の問題点

- **単発・賞味期限のある動画しか作れない**: テーマを入力 → 台本生成 → 終わり
- **ベンチマーク分析なし**: 市場の成功パターンを学習していない
- **戦略的な設計なし**: 「巷と同じような動画」になる
- **ユーザビリティが悪い**: 複数ページを行き来する必要がある
- **ブラックボックス化**: シナリオ生成やスライド生成のロジックが見えない

### 解決策

- **9ステップの自動化**: ベンチマーク分析 → RAG保存 → 戦略設計 → シナリオ生成 → スライド生成 → 音声生成 → 動画合成 → エクスポート
- **RAGによる学習**: ベンチマーク分析結果を蓄積し、時間とともに精度が向上
- **詳細ページでの確認・編集**: 各ステップの詳細を確認・編集可能
- **バックグラウンドジョブ**: ユーザーがページを閉じても処理を継続

---

## 🏗️ システムアーキテクチャ

```
┌─────────────────────────────────────────────────────────┐
│  フロントエンド（React + tRPC）                           │
│  ┌─────────────────────────────────────────────────┐    │
│  │ メインページ: テーマ入力 + 進捗表示              │    │
│  │ サブページ: ベンチマーク分析、戦略、シナリオ、    │    │
│  │            スライドの詳細表示・編集              │    │
│  └─────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────┘
                        ↓ tRPC API
┌─────────────────────────────────────────────────────────┐
│  バックエンド（Express + tRPC）                           │
│  ┌─────────────────────────────────────────────────┐    │
│  │ ジョブ管理API: 作成、進捗取得、詳細取得          │    │
│  │ RAG管理API: 検索、保存                           │    │
│  └─────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│  ジョブワーカー（バックグラウンドプロセス）               │
│  ┌─────────────────────────────────────────────────┐    │
│  │ 9ステップを順次実行:                             │    │
│  │ 1. ベンチマーク動画を検索                        │    │
│  │ 2. ベンチマーク動画を分析                        │    │
│  │ 3. 分析結果をRAGに自動保存                       │    │
│  │ 4. 戦略を設計                                    │    │
│  │ 5. シナリオを生成                                │    │
│  │ 6. スライドを生成                                │    │
│  │ 7. 音声を生成                                    │    │
│  │ 8. 動画を合成                                    │    │
│  │ 9. 動画をエクスポート                            │    │
│  └─────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│  データベース（MySQL/TiDB）                               │
│  - ジョブ状態の永続化                                     │
│  - 進捗情報の保存                                         │
│  - ベンチマーク分析結果                                   │
│  - 戦略、シナリオ、スライド                               │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│  RAG（ChromaDB）                                          │
│  - ベンチマーク分析結果の蓄積                             │
│  - バズる法則の学習                                       │
│  - 類似テーマの成功パターン検索                           │
└─────────────────────────────────────────────────────────┘
```

---

## 📊 動画生成の9ステップ

### ステップ1: ベンチマーク動画を検索（推定時間: 30秒）

**目的**: テーマに関連する成功している動画を検索する

**処理内容**:
1. YouTube Data API v3を使用して、テーマに関連する動画を検索
2. 再生数、高評価数、コメント数などの指標で上位動画を抽出
3. 検索結果をデータベースに保存

**技術**:
- YouTube Data API v3
- 検索クエリの最適化

---

### ステップ2: ベンチマーク動画を分析（推定時間: 3分）

**目的**: ベンチマーク動画の成功要因を分析する

**処理内容**:
1. **動画ダウンロード**: yt-dlpで動画をダウンロード
2. **音声文字起こし**: Whisper APIで全文字起こし
3. **フレーム抽出**: ffmpegで1秒ごとにフレームを抽出
4. **視覚分析**: GPT-4 Visionでスライドのフォント、色、配置、画像、キャラクターを分析
5. **大意抽出**: LLMで動画の大意を抽出
6. **販売者の狙い分析**: LLMで販売者の狙いを分析
7. **ターゲット人格分析**: LLMでターゲット人格を分析
8. **ターゲット人格の反応分析**: LLMでターゲット人格の反応を分析
9. **成功要因分析**: LLMで成功要因を分析
10. **バズる法則抽出**: LLMでバズる法則を抽出

**技術**:
- yt-dlp: 動画ダウンロード
- Whisper API: 音声文字起こし
- ffmpeg: フレーム抽出
- GPT-4 Vision: 視覚分析
- GPT-4: テキスト分析

**分析の「アンテナ」（観察項目）**:

#### (1) シナリオ・ネタ運び分析
- 顕在的興味の惹き方の割合
- 潜在的興味の惹き方の割合
- 他社の不足の提示の割合
- 本当の問題解決の提示の割合
- メンタル負荷の度合い（離脱率に影響）
- フック時間（最初の15秒）
- 問題提起時間
- 解決策提示時間

#### (2) 音声・抑揚分析
- 音声の種類（男性/女性/合成音声）
- 話す速度
- 抑揚の強弱
- 間の取り方

#### (3) スライド・視覚分析
- フォントの大きさと文字の配置
- 色の使い方
- 画像、図などの配置と大きさ
- キャラクターの使い方
- キーワードの選定
- 市場の中での独自性

---

### ステップ3: 分析結果をRAGに自動保存（推定時間: 20秒）

**目的**: ベンチマーク分析結果をRAGに蓄積し、将来の動画生成に活用する

**処理内容**:
1. 分析結果をテキスト形式に整形
2. ChromaDBに保存（ベクトル化）
3. メタデータ（動画URL、タイトル、再生数など）を保存
4. `ragDocuments`テーブルに保存

**RAGに保存する内容**:
```
【動画タイトル】
{タイトル}

【大意】
{大意}

【販売者の狙い】
{販売者の狙い}

【ターゲット人格】
{ターゲット人格}

【ターゲット人格の反応】
{ターゲット人格の反応}

【成功要因】
{成功要因}

【バズる法則】
{バズる法則}

【視覚分析】
{視覚分析}

【全文字起こし】
{全文字起こし}
```

---

### ステップ4: 戦略を設計（推定時間: 1分）

**目的**: テーマを分解し、集客源ネタと解決策ネタを抽出する

**処理内容**:
1. テーマを分解（例: 「SEOとかバズ、プレゼント企画、SNSマーケという人は全員ステップメールを書くべき理由」）
   - 集客源ネタ: SEO、バズ、プレゼント企画、SNSマーケ
   - 解決策ネタ: ステップメール
2. RAGから類似テーマの成功戦略を検索
3. 戦略を生成
4. データベースに保存

**RAGから取得する情報**:
- 類似テーマの成功戦略
- 集客源ネタの効果的な使い方
- 解決策ネタの効果的な提示方法

---

### ステップ5: シナリオを生成（推定時間: 1分30秒）

**目的**: フック、問題提起、解決策の3部構成でシナリオを生成する

**処理内容**:
1. **フック（0:00-0:15）**: 顕在的興味を惹く
2. **問題提起（0:15-1:00）**: 潜在的興味を惹く、他社の不足を提示
3. **解決策（1:00-5:00）**: 本当の問題解決を提示
4. RAGから類似テーマの成功シナリオを検索
5. シナリオを生成
6. データベースに保存

**RAGから取得する情報**:
- 類似テーマの成功シナリオ
- フックの効果的な書き方
- 問題提起の効果的な書き方
- 解決策の効果的な提示方法

---

### ステップ6: スライドを生成（推定時間: 2分）

**目的**: シナリオからスライドを生成する

**処理内容**:
1. シナリオを分割（1スライド = 5-10秒）
2. 各スライドのテキストを生成
3. 各スライドのデザインを生成（フォント、色、配置、画像）
4. RAGから類似テーマの成功スライドを検索
5. スライドを生成
6. データベースに保存

**RAGから取得する情報**:
- 類似テーマの成功スライド
- フォントの効果的な使い方
- 色の効果的な使い方
- 画像の効果的な使い方

**スライドのデータ構造**:
```json
{
  "slides": [
    {
      "id": 1,
      "duration": 5,
      "text": "SEOで集客できない理由",
      "fontSize": 48,
      "fontColor": "#FFFFFF",
      "backgroundColor": "#1E3A8A",
      "textAlign": "center",
      "image": "https://example.com/image1.jpg",
      "imagePosition": "background"
    },
    ...
  ]
}
```

---

### ステップ7: 音声を生成（推定時間: 2分30秒）

**目的**: シナリオから音声を生成する

**処理内容**:
1. シナリオをTTS（Text-to-Speech）で音声に変換
2. 音声ファイルをS3にアップロード
3. データベースに保存

**技術**:
- TTS API（OpenAI TTS、Google Cloud TTS、Amazon Pollyなど）

---

### ステップ8: 動画を合成（推定時間: 3分）

**目的**: スライドと音声を合成してMP4動画を生成する

**処理内容**:
1. 各スライドを画像として生成（HTML → PNG）
2. ffmpegでスライド画像と音声を合成
3. MP4動画を生成
4. 動画ファイルをS3にアップロード
5. データベースに保存

**技術**:
- ffmpeg: 動画合成
- Puppeteer: HTML → PNG変換

**ffmpegコマンド例**:
```bash
ffmpeg -loop 1 -i slide1.png -i audio.mp3 -c:v libx264 -t 5 -pix_fmt yuv420p -vf "scale=1920:1080" output.mp4
```

---

### ステップ9: 動画をエクスポート（推定時間: 1分）

**目的**: 動画をS3にアップロードし、ダウンロードリンクを生成する

**処理内容**:
1. 動画ファイルをS3にアップロード
2. ダウンロードリンクを生成
3. データベースに保存
4. ジョブを完了状態に更新

---

## 📊 実装フェーズ

### Phase 1: 基盤構築（データベース + バックグラウンドジョブ）

| タスク | 内容 | 工数 | 難易度 |
|--------|------|------|--------|
| **1.1 データベーススキーマ設計** | ジョブ、ベンチマーク分析、戦略、シナリオ、スライドのテーブル設計 | 4時間 | ★★☆☆☆ |
| **1.2 バックグラウンドジョブワーカー実装** | ジョブキュー、ステップ実行、進捗管理、エラーハンドリング、再試行ロジック | 16時間 | ★★★★☆ |
| **1.3 サーバー再起動対応** | 未完了ジョブの自動再開、ジョブの永続化 | 4時間 | ★★★☆☆ |
| **小計** | | **24時間** | |

---

### Phase 2: ベンチマーク分析 + RAG統合

| タスク | 内容 | 工数 | 難易度 |
|--------|------|------|--------|
| **2.1 ベンチマーク動画検索** | YouTube Data APIで関連動画を検索 | 3時間 | ★★☆☆☆ |
| **2.2 ベンチマーク動画分析** | 動画ダウンロード、文字起こし、フレーム抽出、視覚分析 | 8時間 | ★★★★☆ |
| **2.3 大意・販売者の狙い・ターゲット人格の分析** | LLMを使った深い分析 | 6時間 | ★★★★☆ |
| **2.4 バズる法則の抽出** | 成功要因の分析、法則の抽出 | 4時間 | ★★★☆☆ |
| **2.5 RAG自動保存** | 分析結果をChromaDBに自動保存 | 6時間 | ★★★☆☆ |
| **2.6 分析アンテナ設定UI** | 何を観察すべきかを設定するUI | 6時間 | ★★★☆☆ |
| **小計** | | **33時間** | |

---

### Phase 3: 戦略設計 + シナリオ生成 + スライド生成

| タスク | 内容 | 工数 | 難易度 |
|--------|------|------|--------|
| **3.1 戦略設計機能** | テーマ分解、集客源ネタ・解決策ネタの抽出、RAGから参考戦略を取得 | 6時間 | ★★★☆☆ |
| **3.2 シナリオ生成機能** | フック、問題提起、解決策の生成、RAGから参考シナリオを取得 | 6時間 | ★★★☆☆ |
| **3.3 スライド生成機能** | シナリオからスライドを生成、RAGから参考スライドを取得 | 8時間 | ★★★★☆ |
| **3.4 戦略設計ページ + ルール記入欄** | 戦略の確認・編集、ルールの記入 | 8時間 | ★★★☆☆ |
| **3.5 シナリオ生成ページ + ルール記入欄** | シナリオの確認・編集、ルールの記入 | 8時間 | ★★★☆☆ |
| **3.6 スライド生成ページ + ルール記入欄** | スライドの確認・編集、ルールの記入 | 10時間 | ★★★★☆ |
| **小計** | | **46時間** | |

---

### Phase 4: 音声生成 + 動画合成 + エクスポート

| タスク | 内容 | 工数 | 難易度 |
|--------|------|------|--------|
| **4.1 音声生成機能** | シナリオから音声を生成（TTS） | 6時間 | ★★★☆☆ |
| **4.2 動画合成機能** | スライド + 音声を合成してMP4動画を生成 | 10時間 | ★★★★☆ |
| **4.3 動画エクスポート機能** | S3にアップロード、ダウンロードリンク生成 | 4時間 | ★★☆☆☆ |
| **小計** | | **20時間** | |

---

### Phase 5: フロントエンドUI

| タスク | 内容 | 工数 | 難易度 |
|--------|------|------|--------|
| **5.1 メインページUI** | テーマ入力、ジョブ開始、進捗表示、履歴一覧 | 8時間 | ★★★☆☆ |
| **5.2 進捗表示UI** | リアルタイム進捗バー、残り時間表示、ステップ状態表示 | 8時間 | ★★★☆☆ |
| **5.3 ベンチマーク分析ページUI** | 分析結果の表示、編集機能 | 8時間 | ★★★☆☆ |
| **5.4 戦略設計ページUI** | 戦略の表示、編集機能、ルール記入欄 | 6時間 | ★★☆☆☆ |
| **5.5 シナリオ生成ページUI** | シナリオの表示、編集機能、ルール記入欄 | 6時間 | ★★☆☆☆ |
| **5.6 スライド生成ページUI** | スライドの表示、編集機能、ルール記入欄 | 8時間 | ★★★☆☆ |
| **5.7 履歴管理UI** | 生成済み動画の一覧、プレビュー、ダウンロード | 6時間 | ★★☆☆☆ |
| **小計** | | **50時間** | |

---

### Phase 6: RAGフィードバックループ + 最適化

| タスク | 内容 | 工数 | 難易度 |
|--------|------|------|--------|
| **6.1 RAGフィードバックループ** | 手動編集結果をRAGにフィードバック | 6時間 | ★★★☆☆ |
| **6.2 RAG検索最適化** | 類似テーマの検索精度向上 | 4時間 | ★★★☆☆ |
| **6.3 エラーハンドリング強化** | 各ステップのエラーハンドリング、ユーザーへの通知 | 6時間 | ★★★☆☆ |
| **6.4 パフォーマンス最適化** | 並列処理、キャッシング | 4時間 | ★★★☆☆ |
| **小計** | | **20時間** | |

---

### Phase 7: テスト + デバッグ

| タスク | 内容 | 工数 | 難易度 |
|--------|------|------|--------|
| **7.1 単体テスト** | 各機能の単体テスト | 8時間 | ★★☆☆☆ |
| **7.2 統合テスト** | エンドツーエンドのテスト | 8時間 | ★★★☆☆ |
| **7.3 バグ修正** | テストで発見されたバグの修正 | 10時間 | ★★★☆☆ |
| **7.4 ユーザビリティテスト** | 実際のユーザーによるテスト | 4時間 | ★★☆☆☆ |
| **小計** | | **30時間** | |

---

## 📈 総工数見積もり

| フェーズ | 内容 | 工数 | 割合 |
|---------|------|------|------|
| **Phase 1** | 基盤構築（データベース + バックグラウンドジョブ） | 24時間 | 11% |
| **Phase 2** | ベンチマーク分析 + RAG統合 | 33時間 | 15% |
| **Phase 3** | 戦略設計 + シナリオ生成 + スライド生成 | 46時間 | 21% |
| **Phase 4** | 音声生成 + 動画合成 + エクスポート | 20時間 | 9% |
| **Phase 5** | フロントエンドUI | 50時間 | 23% |
| **Phase 6** | RAGフィードバックループ + 最適化 | 20時間 | 9% |
| **Phase 7** | テスト + デバッグ | 30時間 | 14% |
| **合計** | | **223時間** | 100% |

---

## ⏱️ 実装期間見積もり

### 作業時間の想定

- **1日8時間作業**: 約28日（約4週間）
- **1日6時間作業**: 約37日（約5.3週間）
- **1日4時間作業**: 約56日（約8週間）

### 推奨スケジュール（1日8時間作業の場合）

| 週 | フェーズ | 工数 | 内容 |
|----|---------|------|------|
| **Week 1** | Phase 1 + Phase 2（前半） | 40時間 | 基盤構築、ベンチマーク分析開始 |
| **Week 2** | Phase 2（後半） + Phase 3（前半） | 40時間 | RAG統合、戦略設計開始 |
| **Week 3** | Phase 3（後半） + Phase 4 | 40時間 | シナリオ・スライド生成、動画合成 |
| **Week 4** | Phase 5 | 40時間 | フロントエンドUI実装 |
| **Week 5** | Phase 6 + Phase 7（前半） | 40時間 | 最適化、テスト開始 |
| **Week 6** | Phase 7（後半） | 23時間 | デバッグ、最終調整 |

---

## 🎯 マイルストーン

| マイルストーン | 完了条件 | 期限 |
|--------------|---------|------|
| **M1: 基盤完成** | バックグラウンドジョブが動作、サーバー再起動対応 | Week 1終了時 |
| **M2: ベンチマーク分析完成** | 動画分析 + RAG保存が自動実行される | Week 2終了時 |
| **M3: コンテンツ生成完成** | 戦略、シナリオ、スライドが自動生成される | Week 3終了時 |
| **M4: 動画出力完成** | MP4動画がエクスポートされる | Week 3終了時 |
| **M5: UI完成** | メインページ + 全サブページが動作 | Week 4終了時 |
| **M6: 最適化完成** | RAGフィードバック、エラーハンドリング強化 | Week 5終了時 |
| **M7: リリース準備完了** | 全テスト完了、バグ修正完了 | Week 6終了時 |

---

## 🔧 技術スタック

| カテゴリ | 技術 | 用途 |
|---------|------|------|
| **フロントエンド** | React 19 + TypeScript | UI実装 |
| **バックエンド** | Express 4 + tRPC 11 | API実装 |
| **データベース** | MySQL/TiDB | ジョブ、分析結果の永続化 |
| **RAG** | ChromaDB + OpenAI Embeddings | ベンチマーク分析結果の蓄積・検索 |
| **動画処理** | yt-dlp + ffmpeg | 動画ダウンロード、合成 |
| **音声処理** | Whisper API + TTS | 文字起こし、音声生成 |
| **画像分析** | GPT-4 Vision | スライド視覚分析 |
| **ジョブキュー** | カスタム実装（データベースベース） | バックグラウンドジョブ管理 |

---

## 📋 実装チェックリスト

### Phase 1: 基盤構築
- [ ] データベーススキーマ設計
- [ ] マイグレーション実行
- [ ] ジョブワーカー実装
- [ ] ジョブキュー実装
- [ ] サーバー再起動対応
- [ ] エラーハンドリング + 再試行ロジック

### Phase 2: ベンチマーク分析 + RAG統合
- [ ] YouTube動画検索API実装
- [ ] 動画ダウンロード機能
- [ ] 文字起こし機能
- [ ] フレーム抽出機能
- [ ] 視覚分析機能
- [ ] 大意抽出機能
- [ ] 販売者の狙い分析機能
- [ ] ターゲット人格分析機能
- [ ] バズる法則抽出機能
- [ ] RAG自動保存機能
- [ ] 分析アンテナ設定UI

### Phase 3: 戦略設計 + シナリオ生成 + スライド生成
- [ ] 戦略設計機能
- [ ] シナリオ生成機能
- [ ] スライド生成機能
- [ ] RAGから参考情報取得機能
- [ ] 戦略設計ページUI
- [ ] シナリオ生成ページUI
- [ ] スライド生成ページUI
- [ ] ルール記入欄実装

### Phase 4: 音声生成 + 動画合成 + エクスポート
- [ ] 音声生成機能（TTS）
- [ ] スライド画像生成機能
- [ ] 動画合成機能（ffmpeg）
- [ ] S3アップロード機能
- [ ] ダウンロードリンク生成

### Phase 5: フロントエンドUI
- [ ] メインページUI
- [ ] 進捗表示UI（リアルタイム）
- [ ] 残り時間表示
- [ ] ベンチマーク分析ページUI
- [ ] 戦略設計ページUI
- [ ] シナリオ生成ページUI
- [ ] スライド生成ページUI
- [ ] 履歴管理UI

### Phase 6: RAGフィードバックループ + 最適化
- [ ] 手動編集結果のRAGフィードバック
- [ ] RAG検索最適化
- [ ] エラーハンドリング強化
- [ ] パフォーマンス最適化

### Phase 7: テスト + デバッグ
- [ ] 単体テスト実装
- [ ] 統合テスト実装
- [ ] バグ修正
- [ ] ユーザビリティテスト

---

## 🎯 成功指標（KPI）

| 指標 | 目標値 | 測定方法 |
|------|--------|---------|
| **動画生成成功率** | 95%以上 | 完了ジョブ数 / 全ジョブ数 |
| **平均生成時間** | 10分以内 | 開始から完了までの平均時間 |
| **RAG蓄積数** | 100件以上（1ヶ月後） | ベンチマーク分析結果の保存数 |
| **ユーザー満足度** | 4.5/5以上 | ユーザーフィードバック |
| **エラー率** | 5%以下 | 失敗ジョブ数 / 全ジョブ数 |

---

## 🚀 次のステップ

1. **Phase 1から実装を開始**
2. **週次で進捗レビュー**
3. **マイルストーンごとにデモ**
4. **ユーザーフィードバックを収集**
5. **継続的に改善**

---

**作成者**: Manus AI  
**最終更新日**: 2025年11月17日

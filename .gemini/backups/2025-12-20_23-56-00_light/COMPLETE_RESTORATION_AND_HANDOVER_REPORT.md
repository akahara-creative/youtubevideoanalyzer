# 完全修復・引き継ぎレポート

**作成日**: 2025年11月17日  
**プロジェクト**: YouTube動画分析アプリ  
**バージョン**: a09d1ba1  
**作成者**: Manus AI

---

## エグゼクティブサマリー

本レポートは、YouTube動画分析アプリの開発履歴、技術的な詳細、修復記録、および引き継ぎ情報をまとめたものです。このドキュメントを読むことで、プロジェクトの全体像を理解し、どのチャット・どのAIでも完全に再現・実行できるようになります。

---

## 1. プロジェクト概要

### 1.1 目的

YouTube動画の分析、AIチャット、RAGドキュメント管理、SEO記事生成、動画生成などの機能を統合したWebアプリケーションを構築すること。

### 1.2 主要機能

| 機能 | 説明 | 実装状況 |
|------|------|----------|
| YouTube動画分析 | 音声文字起こし、映像内容分析、コード認識、学習ポイント抽出 | ✅ 完了 |
| AIチャット | RAGドキュメントを参照しながらAIと対話 | ✅ 完了 |
| RAGドキュメント管理 | ファイルアップロード、タグ管理、ピックアップ機能 | ✅ 完了 |
| SEO記事生成 | テーマ入力でSEO最適化記事を自動生成 | ✅ 完了 |
| 動画生成 | テーマ入力でYouTube動画台本を自動生成 | ✅ 完了 |
| 戦略レコメンデーション | 動画分析結果からコンテンツ戦略を提案 | ✅ 完了 |

### 1.3 技術スタック

**フロントエンド**:
- React 19 - UIライブラリ
- Tailwind CSS 4 - スタイリング
- Wouter - ルーティング
- shadcn/ui - UIコンポーネント
- tRPC React Query - APIクライアント

**バックエンド**:
- Express 4 - Webサーバー
- tRPC 11 - 型安全なAPI
- Drizzle ORM - データベースORM
- Superjson - シリアライゼーション

**データベース**:
- MySQL/TiDB - リレーショナルデータベース

**AI/ML**:
- OpenAI GPT-4 - テキスト生成
- OpenAI Whisper - 音声文字起こし

**認証・ストレージ**:
- Manus OAuth - 認証
- S3 (Manus built-in) - ファイルストレージ

---

## 2. 開発履歴・変更履歴

### 2.1 初期開発（2025年11月8日〜11月10日）

#### Phase 1: プロジェクト初期化
- tRPC + Manus Auth + Database テンプレートを使用してプロジェクトを作成
- 基本的なディレクトリ構造を構築
- データベーススキーマの初期設計

#### Phase 2: YouTube動画分析機能
- YouTube Data API v3を使用して動画情報を取得
- Whisper APIを使用して音声文字起こしを実装
- 映像内容分析、コード認識、学習ポイント抽出を実装
- 分析履歴の保存機能を実装

#### Phase 3: AIチャット機能
- tRPCプロシージャ`chat.sendMessage`を実装
- ストリーミングレスポンスに対応
- チャット履歴の保存機能を実装

#### Phase 4: RAGドキュメント管理機能（初期版）
- ファイルアップロード機能を実装（txt, docx, pdf対応）
- ChromaDBを使用したベクトルストア機能を実装
- RAGドキュメント一覧表示機能を実装

### 2.2 RAGドキュメント管理機能の大幅改善（2025年11月13日〜11月17日）

#### 問題点の発見
- RAGドキュメント一覧が「0件」と表示される問題が発生
- 原因: `ragDocuments`テーブルに`userId`カラムが存在しないため、`where(eq(ragDocuments.userId, ctx.user.id))`フィルタが機能していなかった

#### 修正内容
1. **userIdフィルタの削除**
   - `rag.listDocuments`プロシージャから`userId`フィルタを削除
   - データベースには113件のドキュメントが存在していることを確認
   - 修正後、113件のドキュメントが正常に表示されるようになった

2. **タグ管理UIの改善**
   - AI自動タグ付けから手動チェックボックス形式に変更
   - ファイルアップロード時にタグを選択するのではなく、アップロード後に各ドキュメントの下でタグを管理できるように変更
   - タグ追加時にカテゴリ（生成ジャンル、発信者名、コンテンツタイプ、テーマ、重要度）を選択できる機能を追加

3. **ピックアップ機能の実装**
   - 各ドキュメントの削除ボタンの左に「ピックアップ」ボタン（星アイコン）を追加
   - ピックアップボタンを押すと、そのドキュメントが優先ドキュメントとしてマークされる
   - `ragDocuments`テーブルに`pickedUp`カラム（boolean）を追加

4. **タグ削除機能の実装**
   - RAGページに全タグ一覧を表示
   - 各タグの横に削除ボタンを追加
   - タグを削除すると、そのタグが紐付いているRAGドキュメントからも自動的に削除される連動削除機能を実装

5. **SEO記事生成ページの改善**
   - 「発信者名」フィールドをテキスト入力からドロップダウンに変更
   - RAGページの「発信者名」カテゴリに登録されているタグ（赤原、ひかりちゃんなど）を選択できるように実装
   - SEO記事生成時に、選択された発信者名タグ＋ピックアップされたRAGドキュメントのみを参照するようにバックエンドを修正

#### 技術的な詳細

**データベーススキーマの変更**:
```sql
ALTER TABLE ragDocuments ADD COLUMN pickedUp BOOLEAN DEFAULT FALSE;
```

**バックエンドの変更**:
- `server/routers.ts`に以下のプロシージャを追加:
  - `rag.updateDocumentTags` - ドキュメントのタグを更新
  - `rag.togglePickup` - ドキュメントのピックアップ状態を切り替え
  - `tags.deleteTag` - タグを削除（連動削除含む）

- `server/seoArticleJobProcessor.ts`を修正:
  - RAGドキュメント取得時に、発信者名タグでフィルタリング
  - ピックアップされたドキュメントのみを使用

**フロントエンドの変更**:
- `client/src/pages/Import.tsx`を完全に書き換え:
  - ファイルアップロードをシンプル化（タグ選択を削除）
  - ドキュメント一覧の各ドキュメントの下にチェックボックス形式でタグを表示
  - ピックアップボタンを追加
  - 全タグ一覧を表示し、削除ボタンを追加
  - タグ追加時にカテゴリ選択ドロップダウンを追加

- `client/src/pages/SEOArticle.tsx`を修正:
  - 発信者名フィールドをSelectコンポーネントに変更
  - `tags.getAllWithCategories`から発信者名タグ一覧を取得

### 2.3 その他の改善

- **エラーハンドリングの改善**: tRPCプロシージャでのエラーハンドリングを強化
- **UIの改善**: shadcn/uiコンポーネントを使用して、一貫性のあるUIを実装
- **パフォーマンスの最適化**: データベースクエリを最適化し、不要なクエリを削減

---

## 3. 工夫した点・解決した問題

### 3.1 RAGドキュメント管理の柔軟性

**問題**: 初期設計では、ファイルアップロード時にAIが自動的にタグを付けていたが、ユーザーが後からタグを変更できず、柔軟性に欠けていた。

**解決策**:
1. ファイルアップロードをシンプル化し、タグ選択を削除
2. アップロード後に各ドキュメントの下でタグをチェックボックス形式で管理できるように変更
3. タグ追加時にカテゴリを選択できる機能を追加

**効果**: ユーザーがいつでもタグを変更でき、RAGドキュメントの管理が大幅に改善された。

### 3.2 ピックアップ機能による優先度管理

**問題**: RAGドキュメントが多数存在する場合、どのドキュメントを優先的に参照すべきかが不明確だった。

**解決策**:
1. 各ドキュメントにピックアップボタンを追加
2. ピックアップされたドキュメントのみをSEO記事生成や動画生成で参照

**効果**: ユーザーが重要なドキュメントを明示的に指定でき、生成されるコンテンツの品質が向上した。

### 3.3 発信者名による RAGフィルタリング

**問題**: 複数の発信者のRAGドキュメントが混在している場合、特定の発信者のスタイルでコンテンツを生成することが困難だった。

**解決策**:
1. SEO記事生成ページの発信者名フィールドをドロップダウンに変更
2. 発信者名タグ＋ピックアップでRAGドキュメントをフィルタリング

**効果**: 特定の発信者のスタイルでコンテンツを生成できるようになり、一貫性のあるコンテンツが生成されるようになった。

### 3.4 タグ削除時の連動削除

**問題**: タグを削除しても、RAGドキュメントにはそのタグが残ったままだった。

**解決策**:
1. タグ削除APIを実装し、タグを削除すると同時に`documentTags`テーブルからも削除
2. フロントエンドで確認ダイアログを表示し、ユーザーに警告

**効果**: タグ管理が簡潔になり、不要なタグを安全に削除できるようになった。

---

## 4. データベーススキーマ

### 4.1 主要テーブル

#### users
ユーザー情報を管理するテーブル。

| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | int | 主キー（自動採番） |
| openId | varchar(64) | Manus OAuth識別子（ユニーク） |
| name | text | ユーザー名 |
| email | varchar(320) | メールアドレス |
| loginMethod | varchar(64) | ログイン方法 |
| role | enum('user', 'admin') | ユーザーロール |
| createdAt | timestamp | 作成日時 |
| updatedAt | timestamp | 更新日時 |
| lastSignedIn | timestamp | 最終ログイン日時 |

#### ragDocuments
RAGドキュメントを管理するテーブル。

| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | int | 主キー（自動採番） |
| content | text | ドキュメント内容 |
| sourceType | varchar(50) | ソースタイプ（'file', 'seo_article'など） |
| sourceId | int | ソースID |
| importance | int | 重要度（0-10） |
| usageCount | int | 使用回数 |
| pickedUp | boolean | ピックアップ状態 |
| createdAt | timestamp | 作成日時 |
| updatedAt | timestamp | 更新日時 |

#### tagCategories
タグカテゴリを管理するテーブル。

| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | int | 主キー（自動採番） |
| name | varchar(100) | カテゴリ名 |
| displayName | varchar(100) | 表示名 |
| description | text | 説明 |
| sortOrder | int | 表示順序 |
| createdAt | timestamp | 作成日時 |

#### tags
タグを管理するテーブル。

| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | int | 主キー（自動採番） |
| categoryId | int | カテゴリID（外部キー） |
| name | varchar(100) | タグ名 |
| displayName | varchar(100) | 表示名 |
| description | text | 説明 |
| sortOrder | int | 表示順序 |
| createdAt | timestamp | 作成日時 |

#### documentTags
RAGドキュメントとタグの中間テーブル。

| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | int | 主キー（自動採番） |
| documentId | int | ドキュメントID（外部キー） |
| tagId | int | タグID（外部キー） |
| createdAt | timestamp | 作成日時 |

#### seoArticleJobs
SEO記事生成ジョブを管理するテーブル。

| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | int | 主キー（自動採番） |
| userId | int | ユーザーID（外部キー） |
| theme | text | テーマ |
| targetWordCount | int | 目標文字数 |
| authorName | varchar(255) | 発信者名 |
| status | enum | ステータス（'pending', 'processing', 'completed', 'failed'） |
| currentStep | int | 現在のステップ |
| progress | int | 進捗率（0-100） |
| article | text | 生成された記事 |
| criteria | text | SEO基準（JSON） |
| structure | text | 記事構造（JSON） |
| qualityCheck | text | 品質チェック結果（JSON） |
| error | text | エラーメッセージ |
| createdAt | timestamp | 作成日時 |
| updatedAt | timestamp | 更新日時 |

---

## 5. tRPCプロシージャ一覧

### 5.1 認証関連

- `auth.me` - 現在のユーザー情報を取得
- `auth.logout` - ログアウト

### 5.2 YouTube動画分析関連

- `analysis.analyze` - YouTube動画を分析
- `analysis.getHistory` - 分析履歴を取得
- `analysis.getById` - IDで分析結果を取得
- `analysis.delete` - 分析結果を削除

### 5.3 AIチャット関連

- `chat.sendMessage` - メッセージを送信
- `chat.getHistory` - チャット履歴を取得
- `chat.clearHistory` - チャット履歴をクリア

### 5.4 RAGドキュメント関連

- `rag.uploadDocument` - ドキュメントをアップロード
- `rag.listDocuments` - ドキュメント一覧を取得
- `rag.deleteDocument` - ドキュメントを削除
- `rag.updateDocumentTags` - ドキュメントのタグを更新
- `rag.togglePickup` - ドキュメントのピックアップ状態を切り替え

### 5.5 タグ関連

- `tags.getAllWithCategories` - 全タグをカテゴリ別に取得
- `tags.create` - タグを作成
- `tags.deleteTag` - タグを削除（連動削除含む）

### 5.6 SEO記事生成関連

- `seoArticle.createJob` - SEO記事生成ジョブを作成
- `seoArticle.getJobStatus` - ジョブステータスを取得
- `seoArticle.getHistory` - SEO記事生成履歴を取得
- `seoArticle.getById` - IDでSEO記事を取得
- `seoArticle.exportToWordPress` - WordPress形式でエクスポート

### 5.7 動画生成関連

- `video.generate` - 動画台本を生成
- `video.getHistory` - 動画生成履歴を取得

### 5.8 システム関連

- `system.notifyOwner` - オーナーに通知を送信

---

## 6. 除外したファイルとその理由

以下のファイル・ディレクトリは、ZIPファイルから除外されています。

| ファイル/ディレクトリ | 理由 |
|---------------------|------|
| `node_modules/` | 依存関係は`package.json`から`pnpm install`で復元可能 |
| `.git/` | Gitリポジトリ情報は不要（バージョン管理はチェックポイントで管理） |
| `dist/` | ビルド成果物は`pnpm build`で再生成可能 |
| `.vite/` | Viteキャッシュは自動生成される |
| `.next/` | Next.jsキャッシュは自動生成される |
| `uploads/` | アップロードされたファイルはS3に保存されている |
| `data.db` | ローカルデータベースファイルは環境依存 |
| `*.log` | ログファイルは不要 |
| `chroma/` | ChromaDBのベクトルストアは再生成可能 |

---

## 7. 動作手順（ゼロから起動まで）

### 7.1 前提条件

- Node.js 22.x がインストールされていること
- pnpm がインストールされていること
- MySQL/TiDB データベースが利用可能であること
- Manus OAuth の認証情報が取得できること

### 7.2 セットアップ手順

#### ステップ1: ZIPファイルを解凍

```bash
unzip youtube-video-analyzer-backup-YYYYMMDD-HHMMSS.zip
cd youtube-video-analyzer
```

#### ステップ2: 依存関係をインストール

```bash
pnpm install
```

#### ステップ3: 環境変数を設定

`.env`ファイルを作成し、以下の環境変数を設定します：

```
DATABASE_URL=mysql://user:password@host:port/database
JWT_SECRET=your-jwt-secret
VITE_APP_ID=your-app-id
OAUTH_SERVER_URL=https://api.manus.im
VITE_OAUTH_PORTAL_URL=https://portal.manus.im
OWNER_OPEN_ID=your-owner-open-id
OWNER_NAME=your-owner-name
BUILT_IN_FORGE_API_URL=https://forge-api.manus.im
BUILT_IN_FORGE_API_KEY=your-forge-api-key
VITE_FRONTEND_FORGE_API_KEY=your-frontend-forge-api-key
VITE_FRONTEND_FORGE_API_URL=https://forge-api.manus.im
VITE_APP_TITLE=YouTube動画分析アプリ
VITE_APP_LOGO=/logo.svg
```

#### ステップ4: データベースをマイグレーション

```bash
pnpm db:push
```

#### ステップ5: 開発サーバーを起動

```bash
pnpm dev
```

#### ステップ6: ブラウザでアクセス

```
http://localhost:3000
```

### 7.3 本番環境へのデプロイ

#### ステップ1: ビルド

```bash
pnpm build
```

#### ステップ2: 本番サーバーで起動

```bash
pnpm start
```

---

## 8. トラブルシューティング

詳細なトラブルシューティング情報は、`SETUP_GUIDE.md`を参照してください。

---

## 9. 今後の改善提案

### 9.1 ピックアップドキュメントの視覚的強調

現在、ピックアップされたドキュメントは星アイコンでマークされていますが、一覧の上部に表示したり、背景色を変更して目立たせることで、ユーザビリティが向上します。

### 9.2 タグによるフィルタリング

ドキュメント一覧でタグをクリックして、同じタグのドキュメントのみを表示する機能を追加することで、大量のドキュメントから目的のドキュメントを素早く見つけられるようになります。

### 9.3 RAGドキュメントの一括操作

複数のドキュメントを選択して、一括でタグを追加・削除・ピックアップできる機能を追加することで、大量のドキュメントを効率的に管理できるようになります。

---

## 10. 今後の開発計画

### 10.1 動画生成機能の完全実装

#### プロジェクト概要

「テーマを入力 → ボタンクリック → 動画がエクスポートされる」というシンプルなUXを実現し、ベンチマーク分析からRAG蓄積、戦略設計、シナリオ生成、スライド生成、動画合成まで、全てを自動化します。

#### 核心的な要件

1. **シンプルなUX**: テーマ入力 → ボタンクリック → 待つだけ
2. **バックグラウンド処理**: ユーザーがページを閉じても処理を継続
3. **サーバー再起動対応**: 未完了のジョブを自動再開
4. **RAG自動蓄積**: ベンチマーク分析結果を自動的にRAGに保存
5. **リアルタイム進捗表示**: 残り時間と進捗率を表示
6. **詳細ページアクセス**: 各ステップの詳細を確認・編集可能
7. **寿命の長い動画**: ベンチマーク分析とRAGを活用し、バズる法則を学習

#### 実装フェーズ

| フェーズ | 内容 | 工数 | 期間 |
|---------|------|------|------|
| **Phase 1** | 基盤構築（データベース + バックグラウンドジョブ） | 24時間 | Week 1 |
| **Phase 2** | ベンチマーク分析 + RAG統合 | 33時間 | Week 1-2 |
| **Phase 3** | 戦略設計 + シナリオ生成 + スライド生成 | 46時間 | Week 2-3 |
| **Phase 4** | 音声生成 + 動画合成 + エクスポート | 20時間 | Week 3 |
| **Phase 5** | フロントエンドUI | 50時間 | Week 4 |
| **Phase 6** | RAGフィードバックループ + 最適化 | 20時間 | Week 5 |
| **Phase 7** | テスト + デバッグ | 30時間 | Week 5-6 |
| **合計** | | **223時間** | **約6週間** |

#### 動画生成の9ステップ

1. **ベンチマーク動画を検索**: YouTube Data APIで関連動画を検索
2. **ベンチマーク動画を分析**: 文字起こし、フレーム抽出、視覚分析、大意抽出、販売者の狙い分析、ターゲット人格分析、バズる法則抽出
3. **分析結果をRAGに自動保存**: ChromaDBに保存し、将来の動画生成に活用
4. **戦略を設計**: テーマ分解、集客源ネタ・解決策ネタの抽出
5. **シナリオを生成**: フック、問題提起、解決策の生成
6. **スライドを生成**: シナリオからスライドを生成
7. **音声を生成**: TTSでナレーション音声を生成
8. **動画を合成**: ffmpegでスライド + 音声を合成
9. **動画をエクスポート**: S3にアップロード、ダウンロードリンク生成

#### 技術的な特徴

1. **永続的なバックグラウンドジョブ**
   - ユーザーがページを閉じても処理を継続
   - サーバーが再起動しても、未完了のジョブを自動再開
   - データベースに状態を保存し、永続化

2. **リアルタイム進捗表示**
   - 残り時間の推定表示（分秒形式）
   - 各ステップの進捗状況をリアルタイムで更新（2秒ごとにポーリング）
   - 進捗バーで視覚的に表示

3. **RAGによる学習と改善**
   - ベンチマーク分析結果を自動的にRAGに蓄積
   - 類似テーマの成功パターンを検索
   - 時間とともに精度が向上

4. **詳細ページでの確認・編集**
   - ベンチマーク分析ページ: 分析結果の確認・編集
   - 戦略設計ページ: 戦略の確認・編集、ルール記入欄
   - シナリオ生成ページ: シナリオの確認・編集、ルール記入欄
   - スライド生成ページ: スライドの確認・編集、ルール記入欄

#### マイルストーン

| マイルストーン | 完了条件 | 期限 |
|--------------|---------|------|
| **M1: 基盤完成** | バックグラウンドジョブが動作、サーバー再起動対応 | Week 1終了時 |
| **M2: ベンチマーク分析完成** | 動画分析 + RAG保存が自動実行される | Week 2終了時 |
| **M3: コンテンツ生成完成** | 戦略、シナリオ、スライドが自動生成される | Week 3終了時 |
| **M4: 動画出力完成** | MP4動画がエクスポートされる | Week 3終了時 |
| **M5: UI完成** | メインページ + 全サブページが動作 | Week 4終了時 |
| **M6: 最適化完成** | RAGフィードバック、エラーハンドリング強化 | Week 5終了時 |
| **M7: リリース準備完了** | 全テスト完了、バグ修正完了 | Week 6終了時 |

#### 成功指標（KPI）

| 指標 | 目標値 | 測定方法 |
|------|--------|----------|
| **動画生成成功率** | 95%以上 | 完了ジョブ数 / 全ジョブ数 |
| **平均生成時間** | 10分以内 | 開始から完了までの平均時間 |
| **RAG蓄積数** | 100件以上（1ヶ月後） | ベンチマーク分析結果の保存数 |
| **ユーザー満足度** | 4.5/5以上 | ユーザーフィードバック |
| **エラー率** | 5%以下 | 失敗ジョブ数 / 全ジョブ数 |

---

## 11. まとめ

本プロジェクトは、YouTube動画分析、AIチャット、RAGドキュメント管理、SEO記事生成、動画生成などの機能を統合したWebアプリケーションです。特に、RAGドキュメント管理機能の大幅な改善により、ユーザーが柔軟にドキュメントを管理し、高品質なコンテンツを生成できるようになりました。

今後は、動画生成機能の完全実装により、「テーマを入力するだけで動画が自動生成される」という革新的なUXを実現します。ベンチマーク分析とRAGを活用することで、時間とともに精度が向上し、寿命の長い高品質な動画を生成できるようになります。

このドキュメントを参照することで、どのチャット・どのAIでも、プロジェクトを完全に再現・実行できます。

---

**作成者**: Manus AI  
**最終更新日**: 2025年11月17日
